<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mora Test</title>
  <style>
    :root {
      --glow: 0 0 12px rgba(100, 140, 255, 0.5);
      --glow-strong: 0 0 20px rgba(120, 160, 255, 0.7);
      --blur: blur(14px);
      --bg: rgba(10, 12, 28, 0.75);
      --text: #e6f0ff;
      --card: rgba(25, 30, 55, 0.55);
      --primary: #6a8cff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --sidebar-bg: #0f172a;
      --sidebar-active: #1e293b;
      --sidebar-btn: #10b981;
      --sidebar-btn-hover: #059669;
      --divider: rgba(106, 140, 255, 0.15);
      --results-bg: #0c1529;
      --notes-bg: transparent;
      --dark-blue-bg: linear-gradient(135deg, #0b1225, #121a35);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); }
    body {
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--dark-blue-bg);
    }
    body::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 20% 30%, rgba(106, 140, 255, 0.12) 0%, transparent 40%),
                  radial-gradient(circle at 80% 70%, rgba(138, 43, 226, 0.08) 0%, transparent 40%);
      animation: backgroundMove 30s infinite alternate ease-in-out;
      pointer-events: none;
      z-index: -2;
    }
    @keyframes backgroundMove {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .screen {
      display: none;
      width: 100%;
      min-height: 100vh;
      padding: 16px;
      background: transparent;
    }
    .screen.active {
      display: block;
    }
    #admin-dashboard {
      display: none;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      background: var(--sidebar-bg);
    }
    #admin-dashboard.active {
      display: flex;
    }
    .form-container {
      max-width: 450px;
      margin: 0 auto;
      padding: 24px 20px;
      background: rgba(20, 25, 50, 0.4);
      backdrop-filter: var(--blur);
      border-radius: 28px;
      box-shadow: var(--glow);
      border: none;
      transform: translateY(0);
      animation: fadeInUp 0.9s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
      position: relative;
      z-index: 2;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .logo {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 10px;
      text-align: center;
      background: linear-gradient(135deg, #6a8cff, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 12px rgba(106, 140, 255, 0.4);
    }
    h1, h2, h3 {
      text-align: center;
      margin-bottom: 16px;
      font-weight: 600;
      text-shadow: 0 0 8px rgba(106, 140, 255, 0.6);
    }
    .btn {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: rgba(106, 140, 255, 0.18);
      border: none;
      color: var(--text);
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--glow);
    }
    .btn:hover {
      background: rgba(106, 140, 255, 0.35);
      box-shadow: var(--glow-strong);
      transform: translateY(-2px);
    }
    .btn-sm {
      width: auto;
      padding: 8px 16px;
      font-size: 14px;
      margin: 5px;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      background: rgba(20, 30, 60, 0.5);
      border: none;
      color: var(--text);
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: inset 0 0 6px rgba(106, 140, 255, 0.2);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(106, 140, 255, 0.4);
    }
    .subjects-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
      align-items: center;
    }
    .subject-card {
      width: 100%;
      max-width: 600px;
      padding: 20px;
      background: var(--card);
      border-radius: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      backdrop-filter: var(--blur);
      box-shadow: var(--glow);
      border: none;
      transform-style: preserve-3d;
      position: relative;
      overflow: hidden;
      font-size: 16px;
      will-change: transform, box-shadow;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .subject-card:hover:not(.disabled):not(.completed) {
      transform: translateY(-8px) rotateX(5deg) scale(1.02);
      box-shadow: var(--glow-strong);
    }
    .subject-card.disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none !important;
    }
    .subject-card.completed {
      opacity: 0.9;
      cursor: pointer;
    }
    .subject-card.disabled h3,
    .subject-card.completed h3 {
      color: #aaa;
    }
    .subject-card.completed h3 {
      color: var(--success);
    }
    .lock-icon {
      display: inline-block;
      width: 32px;
      height: 32px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23f44336' d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      margin-top: 12px;
      animation: floatPulse 3s infinite ease-in-out;
    }
    .exclamation-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      color: var(--warning);
      font-weight: bold;
      font-size: 20px;
      text-shadow: 0 0 10px rgba(255, 152, 0, 0.6);
    }
    @keyframes floatPulse {
      0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
      50% { transform: translateY(-6px) scale(1.1); opacity: 0.8; }
    }
    .activation-message,
    .completion-message {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(20, 25, 50, 0.85);
      padding: 14px;
      font-size: 14px;
      text-align: center;
      transform: translateY(100%);
      transition: transform 0.4s ease;
      border-radius: 0 0 20px 20px;
    }
    .subject-card.disabled.clicked .activation-message,
    .subject-card.completed.clicked .completion-message {
      transform: translateY(0);
    }
    .subject-card.completed .completion-message {
      color: var(--success);
    }
    #notes-screen textarea,
    #notes-screen .btn {
      border: none;
      background: rgba(20, 30, 60, 0.5);
      box-shadow: none;
      border-radius: 16px;
      outline: none;
    }
    #notes-screen .form-container {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
    }
    #notes-screen h2, #notes-screen h3 {
      background: transparent;
      -webkit-text-fill-color: var(--text);
    }
    #student-dashboard,
    #results-screen,
    #notes-screen,
    #profile-screen,
    #register-screen,
    #login-screen,
    #auth-screen,
    #exam-screen,
    #exam-intro,
    #exam-result,
    #exam-list-screen,
    #certificates-screen {
      background: var(--dark-blue-bg);
    }
    #results-screen .form-container {
      background: rgba(20, 30, 60, 0.5);
      border: none;
      border-radius: 20px;
      box-shadow: var(--glow);
    }
    .captcha-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
    }
    .captcha-display {
      padding: 12px 18px;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      font-weight: bold;
      font-size: 20px;
      letter-spacing: 4px;
      color: #fff;
      min-width: 110px;
      text-align: center;
      user-select: none;
      box-shadow: 0 0 10px rgba(106, 140, 255, 0.3);
    }
    .captcha-input {
      flex: 1;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
    }
    .chip {
      padding: 10px 16px;
      background: rgba(40, 50, 90, 0.6);
      border-radius: 50px;
      font-size: 14px;
      box-shadow: 0 0 8px rgba(106, 140, 255, 0.4);
      transform-style: preserve-3d;
      transition: transform 0.3s ease;
    }
    .chip:hover {
      transform: translateY(-3px) rotateX(5deg);
    }
    .countdown-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(10, 15, 30, 0.92);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      backdrop-filter: var(--blur);
    }
    .countdown-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    .countdown-number {
      font-size: 100px;
      font-weight: bold;
      color: var(--primary);
      text-shadow: 0 0 20px rgba(106, 140, 255, 0.8);
      margin: 20px 0;
      animation: scalePulse 1s infinite alternate;
    }
    @keyframes scalePulse {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(20, 30, 60, 0.7);
      backdrop-filter: var(--blur);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 99;
      box-shadow: 0 -4px 20px rgba(106, 140, 255, 0.3);
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .nav-item.active {
      color: var(--primary);
      text-shadow: 0 0 10px rgba(106, 140, 255, 0.8);
    }
    .nav-icon {
      font-size: 24px;
      margin-bottom: 4px;
    }
    .exam-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      background: var(--card);
      border-radius: 20px;
      backdrop-filter: var(--blur);
      box-shadow: var(--glow);
      border: none;
    }
    .timer {
      text-align: center;
      font-size: 24px;
      margin-bottom: 25px;
      color: var(--warning);
      font-weight: bold;
    }
    .question {
      margin-bottom: 25px;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .option {
      padding: 12px;
      background: rgba(30, 50, 100, 0.4);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .option:hover {
      background: rgba(50, 70, 130, 0.5);
      box-shadow: 0 0 8px rgba(106, 140, 255, 0.5);
    }
    .option.selected {
      background: rgba(76, 175, 80, 0.2);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    .canvas-container {
      margin-top: 30px;
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      backdrop-filter: var(--blur);
    }
    canvas {
      width: 100%;
      height: auto;
      max-height: 400px;
    }
    .hidden {
      display: none !important;
    }
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 50, 100, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .toast.show {
      opacity: 1;
    }
    #profile-screen {
      padding-top: 80px !important;
    }
    .profile-header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6a8cff, #8a2be2);
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: white;
      box-shadow: var(--glow-strong);
      animation: rotateGlow 10s infinite linear;
    }
    @keyframes rotateGlow {
      0% { transform: rotate(0deg); box-shadow: 0 0 20px rgba(106, 140, 255, 0.8); }
      100% { transform: rotate(360deg); box-shadow: 0 0 30px rgba(138, 43, 226, 0.8); }
    }
    .profile-name {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(to right, #6a8cff, #8a2be2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .profile-branch {
      color: var(--primary);
      font-size: 16px;
    }
    .profile-info-item {
      display: flex;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid var(--divider);
      font-size: 15px;
    }
    .profile-info-label {
      color: rgba(224, 240, 255, 0.8);
    }
    .profile-info-value {
      color: var(--text);
      font-weight: 500;
    }
    #btn-logout {
      width: auto;
      padding: 6px 18px;
      font-size: 13px;
      background: transparent;
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: var(--danger);
      border-radius: 50px;
      box-shadow: none;
      margin-top: 10px;
      margin: 0 auto;
      display: block;
      transition: all 0.3s ease;
    }
    #btn-logout:hover {
      background: rgba(244, 67, 54, 0.1);
      transform: scale(1.05);
      border-color: var(--danger);
      box-shadow: 0 0 10px rgba(244, 67, 54, 0.4);
    }
    .profile-actions {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .action-card {
      background: var(--card);
      padding: 16px;
      border-radius: 18px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
    }
    .action-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: var(--glow-strong);
    }
    .action-title {
      font-weight: bold;
      margin-bottom: 6px;
      color: var(--primary);
    }
    .action-desc {
      font-size: 13px;
      color: rgba(224, 240, 255, 0.8);
    }
    #reg-subjects {
      display: none !important;
    }
    .admin-sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      overflow-y: auto;
      border-right: 1px solid var(--divider);
      display: flex;
      flex-direction: column;
    }
    .admin-sidebar-header {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      background: var(--sidebar-active);
      border-bottom: 1px solid var(--divider);
    }
    .admin-menu {
      padding: 20px 0;
      flex-grow: 1;
    }
    .admin-menu-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
    }
    .admin-menu-item:hover {
      background: var(--sidebar-active);
    }
    .admin-menu-item.active {
      background: var(--sidebar-active);
      color: var(--primary);
      font-weight: bold;
    }
    .admin-menu-item i {
      font-size: 20px;
    }
    .admin-logout {
      padding: 15px 20px;
      background: var(--danger);
      color: white;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
      margin-top: auto;
    }
    .admin-logout:hover {
      background: #d32f2f;
    }
    .admin-content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--bg);
    }
    .admin-tab {
      display: none;
    }
    .admin-tab.active {
      display: block;
    }
    .admin-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .stat-box {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
      transition: transform 0.3s ease;
    }
    .stat-box:hover {
      transform: translateY(-5px);
      box-shadow: var(--glow-strong);
    }
    .stat-title {
      font-size: 16px;
      color: rgba(224, 240, 255, 0.8);
      margin-bottom: 10px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
    }
    .students-list {
      margin-top: 20px;
    }
    .student-card {
      background: var(--card);
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
    }
    .student-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--divider);
    }
    .student-name {
      font-weight: bold;
      font-size: 18px;
    }
    .student-location {
      color: rgba(224, 240, 255, 0.8);
      font-size: 14px;
    }
    .student-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .detail-item {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    .detail-label {
      color: rgba(224, 240, 255, 0.8);
      font-weight: 500;
    }
    .detail-value {
      font-weight: 500;
    }
    .student-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .btn-action {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-delete {
      background: var(--danger);
      color: white;
    }
    .btn-delete:hover {
      background: #d32f2f;
    }
    .btn-ban {
      background: #ff9800;
      color: white;
    }
    .btn-ban:hover {
      background: #fb8c00;
    }
    .btn-unban {
      background: var(--success);
      color: white;
    }
    .btn-unban:hover {
      background: #4caf50;
    }
    .btn-ip-ban {
      background: #ff9800;
      color: white;
    }
    .btn-ip-ban:hover {
      background: #fb8c00;
    }
    .btn-ip-unban {
      background: var(--success);
      color: white;
    }
    .btn-ip-unban:hover {
      background: #4caf50;
    }
    .exam-management-layout {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .subjects-panel {
      width: 100%;
      max-width: 250px;
      background: var(--card);
      border-radius: 16px;
      padding: 15px;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
    }
    .questions-panel {
      flex-grow: 1;
      min-width: 300px;
      background: var(--card);
      border-radius: 16px;
      padding: 15px;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
      display: none;
    }
    .questions-panel.active {
      display: block;
    }
    .question-item {
      background: rgba(30, 50, 100, 0.2);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: inset 0 0 8px rgba(106, 140, 255, 0.1);
    }
    .question-type {
      margin-bottom: 10px;
    }
    .question-type label,
    .correct-answer label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .question-type-select,
    .correct-answer-select {
      width: 100%;
      padding: 8px;
      background: rgba(20, 30, 60, 0.5);
      border: none;
      color: var(--text);
      border-radius: 8px;
      font-size: 14px;
    }
    .input-group {
      margin-bottom: 10px;
    }
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .question-text {
      width: 100%;
      padding: 8px;
      background: rgba(20, 30, 60, 0.5);
      border: none;
      color: var(--text);
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
    }
    .options-container {
      margin-bottom: 10px;
    }
    .option-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }
    .option-input label {
      font-size: 14px;
      min-width: 70px;
    }
    .option-input-field {
      flex-grow: 1;
      padding: 6px 8px;
      background: rgba(20, 30, 60, 0.5);
      border: none;
      color: var(--text);
      border-radius: 6px;
      font-size: 14px;
    }
    .remove-question {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background 0.2s;
    }
    .remove-question:hover {
      background: #d32f2f;
    }
    .add-question-btn,
    .upload-exam-btn {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 14px;
    }
    .uploaded-exams-list {
      margin-top: 20px;
    }
    .uploaded-exam-item {
      background: var(--card);
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .uploaded-exam-actions {
      display: flex;
      gap: 5px;
    }
    .btn-view,
    .btn-hide,
    .btn-delete-exam {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-view {
      background: var(--primary);
      color: white;
    }
    .btn-view:hover {
      background: #5a7dff;
    }
    .btn-hide {
      background: var(--warning);
      color: white;
    }
    .btn-hide:hover {
      background: #ff8f00;
    }
    .btn-delete-exam {
      background: var(--danger);
      color: white;
    }
    .btn-delete-exam:hover {
      background: #d32f2f;
    }
    .logs-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .logs-table th,
    .logs-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--divider);
      font-size: 14px;
    }
    .logs-table th {
      background: rgba(20, 30, 60, 0.3);
      font-weight: bold;
    }
    .logs-table .btn-delete-log {
      padding: 4px 8px;
      font-size: 12px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .logs-table .btn-delete-log:hover {
      background: #d32f2f;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .setting-card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .setting-card h3 {
      margin-bottom: 15px;
      font-size: 16px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(20, 30, 60, 0.5);
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background: var(--primary);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .exam-view-inline {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: var(--glow);
      backdrop-filter: var(--blur);
    }
    /* === Certificate Section: Realistic Image-Based Design === */
    #certificates-screen {
      padding-top: 80px !important;
    }
    #certificates-screen h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary);
    }
    .certificate-container {
      max-width: 800px;
      margin: 20px auto;
      text-align: center;
    }
    .certificate-canvas {
      width: 100%;
      max-width: 700px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      margin-bottom: 15px;
      background: white;
    }
    .certificate-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 10px;
    }
    .btn-download-pdf {
      padding: 8px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      box-shadow: var(--glow);
    }
    .btn-download-pdf:hover {
      background: #5a7dff;
      transform: translateY(-2px);
      box-shadow: var(--glow-strong);
    }
    @media (max-width: 768px) {
      .form-container {
        padding: 20px 16px;
      }
      .nav-icon {
        font-size: 20px;
      }
      .exam-container {
        margin: 20px 10px;
        padding: 20px;
      }
      .certificate-canvas {
        max-width: 95%;
      }
      .admin-sidebar {
        width: 240px;
      }
      .admin-content, .admin-sidebar {
        font-size: 14px;
      }
      .admin-menu-item i {
        font-size: 18px;
      }
    }
    @media (max-width: 480px) {
      .nav-item span {
        font-size: 11px;
      }
      .nav-icon {
        font-size: 18px;
      }
      h1 { font-size: 20px; }
      h2 { font-size: 18px; }
      .form-container {
        padding: 18px 12px;
      }
      .btn {
        font-size: 15px;
        padding: 10px;
      }
      .certificate-canvas {
        max-width: 100%;
      }
    }
  </style>
</head>
<body class="dark-mode">
  <!-- Authentication Screens -->
  <div id="auth-screen" class="screen active">
    <div class="form-container">
      <div class="logo">Mora Test</div>
      <h1>Ù…Ù†ØµØ© Mora Test Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© (MCQ)</h1>
      <button class="btn" id="btn-register">Ø§Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨</button>
      <button class="btn" id="btn-login">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</button>
    </div>
  </div>
  <div id="register-screen" class="screen">
    <div class="form-container">
      <div class="logo">Mora Test</div>
      <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
      <div class="input-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="reg-username" />
      </div>
      <div class="input-group">
        <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
        <select id="reg-branch">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
          <option value="business">Ø£Ø¹Ù…Ø§Ù„</option>
          <option value="systems">Ù†Ø¸Ù…</option>
        </select>
      </div>
      <div class="input-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="reg-password" />
      </div>
      <div class="input-group">
        <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="reg-confirm" />
      </div>
      <div class="captcha-container">
        <div class="captcha-display" id="register-captcha-display"></div>
        <input type="text" class="captcha-input" id="register-captcha-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø£Ø¹Ù„Ø§Ù‡" />
      </div>
      <div id="reg-subjects" class="chips"></div>
      <button class="btn" id="btn-submit-register">ØªØ³Ø¬ÙŠÙ„</button>
      <button class="btn btn-danger" id="btn-back-to-auth">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
  </div>
  <div id="login-screen" class="screen">
    <div class="form-container">
      <div class="logo">Mora Test</div>
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="input-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="login-username" />
      </div>
      <div class="input-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="login-password" />
      </div>
      <button class="btn" id="btn-submit-login">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn btn-danger" id="btn-back-to-auth2">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
  </div>
  <!-- Student Screens -->
  <div id="student-dashboard" class="screen">
    <div style="max-width:600px; width:100%;">
      <h1 style="text-align:center;">Ù…Ù†ØµØ© Mora Test</h1>
      <div class="subjects-grid" id="student-subjects"></div>
    </div>
    <div class="nav-bar">
      <div class="nav-item active" data-screen="student-dashboard">
        <div class="nav-icon">ğŸ </div>
        <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
      <div class="nav-item" data-screen="results-screen">
        <div class="nav-icon">ğŸ“Š</div>
        <div>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
      </div>
      <div class="nav-item" data-screen="notes-screen">
        <div class="nav-icon">ğŸ“</div>
        <div>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="certificates-screen">
        <div class="nav-icon">ğŸ…</div>
        <div>Ø´Ù‡Ø§Ø¯Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="profile-screen">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      </div>
    </div>
  </div>
  <div id="results-screen" class="screen">
    <div style="padding:20px;max-width:900px;margin:0 auto;">
      <h2>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
      <div id="results-list" style="margin-top:20px;"></div>
    </div>
    <div class="nav-bar">
      <div class="nav-item" data-screen="student-dashboard">
        <div class="nav-icon">ğŸ </div>
        <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
      <div class="nav-item active" data-screen="results-screen">
        <div class="nav-icon">ğŸ“Š</div>
        <div>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
      </div>
      <div class="nav-item" data-screen="notes-screen">
        <div class="nav-icon">ğŸ“</div>
        <div>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="certificates-screen">
        <div class="nav-icon">ğŸ…</div>
        <div>Ø´Ù‡Ø§Ø¯Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="profile-screen">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      </div>
    </div>
  </div>
  <div id="notes-screen" class="screen">
    <div style="max-width:600px;margin:0 auto;padding:0 20px;">
      <div class="form-container">
        <h2>Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø© + Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</h2>
        <div style="margin:20px 0;">
          <h3>Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø©:</h3>
          <div class="chips" style="margin-top:10px;">
            <div class="chip">Ù„Ø§ ØªØºÙ„Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</div>
            <div class="chip">ØªØ£ÙƒØ¯ Ù…Ù† Ø«Ø¨Ø§Øª Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</div>
          </div>
        </div>
        <div class="input-group">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</label>
          <textarea id="user-notes" rows="6" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù‡Ù†Ø§..."></textarea>
        </div>
        <button class="btn" id="save-notes">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
      </div>
    </div>
    <div class="nav-bar">
      <div class="nav-item" data-screen="student-dashboard">
        <div class="nav-icon">ğŸ </div>
        <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
      <div class="nav-item" data-screen="results-screen">
        <div class="nav-icon">ğŸ“Š</div>
        <div>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
      </div>
      <div class="nav-item active" data-screen="notes-screen">
        <div class="nav-icon">ğŸ“</div>
        <div>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="certificates-screen">
        <div class="nav-icon">ğŸ…</div>
        <div>Ø´Ù‡Ø§Ø¯Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="profile-screen">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      </div>
    </div>
  </div>
  <!-- Certificates Screen -->
  <div id="certificates-screen" class="screen">
    <div style="max-width:900px;margin:0 auto;padding:0 20px;">
      <h2>ğŸ… Ø´Ù‡Ø§Ø¯Ø§ØªÙŠ</h2>
      <div id="certificates-list"></div>
    </div>
    <div class="nav-bar">
      <div class="nav-item" data-screen="student-dashboard">
        <div class="nav-icon">ğŸ </div>
        <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
      <div class="nav-item" data-screen="results-screen">
        <div class="nav-icon">ğŸ“Š</div>
        <div>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
      </div>
      <div class="nav-item" data-screen="notes-screen">
        <div class="nav-icon">ğŸ“</div>
        <div>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item active" data-screen="certificates-screen">
        <div class="nav-icon">ğŸ…</div>
        <div>Ø´Ù‡Ø§Ø¯Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="profile-screen">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      </div>
    </div>
  </div>
  <div id="profile-screen" class="screen">
    <div style="max-width:600px;margin:0 auto;padding:0 20px;">
      <div class="profile-header">
        <div class="profile-avatar">ğŸ‘¤</div>
        <div class="profile-name" id="profile-display-username"></div>
        <div class="profile-branch" id="profile-display-branch"></div>
        <button id="btn-logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
      <div class="profile-info-item">
        <span class="profile-info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span>
        <span class="profile-info-value" id="profile-display-registered"></span>
      </div>
      <div class="profile-info-item">
        <span class="profile-info-label">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±:</span>
        <span class="profile-info-value" id="profile-display-last-seen"></span>
      </div>
      <div class="profile-info-item">
        <span class="profile-info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª:</span>
        <span class="profile-info-value" id="profile-display-exams"></span>
      </div>
    </div>
    <div class="nav-bar">
      <div class="nav-item" data-screen="student-dashboard">
        <div class="nav-icon">ğŸ </div>
        <div>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>
      <div class="nav-item" data-screen="results-screen">
        <div class="nav-icon">ğŸ“Š</div>
        <div>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
      </div>
      <div class="nav-item" data-screen="notes-screen">
        <div class="nav-icon">ğŸ“</div>
        <div>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item" data-screen="certificates-screen">
        <div class="nav-icon">ğŸ…</div>
        <div>Ø´Ù‡Ø§Ø¯Ø§ØªÙŠ</div>
      </div>
      <div class="nav-item active" data-screen="profile-screen">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
      </div>
    </div>
  </div>
  <div id="exam-screen" class="screen">
    <div class="exam-container">
      <div class="timer" id="exam-timer">25:00</div>
      <div id="exam-content"></div>
      <button class="btn" id="btn-submit-exam" style="margin-top:20px;" disabled>ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
    </div>
  </div>
  <div id="exam-intro" class="screen">
    <div class="form-container">
      <h2 id="intro-subject-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</h2>
      <p>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...</p>
      <button class="btn" id="btn-start-exam">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
      <button class="btn btn-danger" id="btn-back-from-exam">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
  </div>
  <div id="exam-result" class="screen">
    <div class="form-container">
      <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
      <div id="result-summary"></div>
      <button class="btn" id="btn-back-to-dashboard">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
  </div>
  <div id="exam-list-screen" class="screen"></div>
  <!-- Admin Dashboard -->
  <div id="admin-dashboard" class="screen">
    <div class="admin-sidebar">
      <div class="admin-sidebar-header">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div class="admin-menu">
        <div class="admin-menu-item active" data-tab="dashboard">
          <i>ğŸ“Š</i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        </div>
        <div class="admin-menu-item" data-tab="students">
          <i>ğŸ“</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
        </div>
        <div class="admin-menu-item" data-tab="subjects">
          <i>ğŸ“š</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯
        </div>
        <div class="admin-menu-item" data-tab="exams">
          <i>ğŸ“</i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
        </div>
        <div class="admin-menu-item" data-tab="uploaded-exams">
          <i>ğŸ“¤</i> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
        </div>
        <div class="admin-menu-item" data-tab="reports">
          <i>ğŸ“ˆ</i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        </div>
        <div class="admin-menu-item" data-tab="logs">
          <i>ğŸ“œ</i> Ù†ØªØ§Ø¦Ø¬
        </div>
        <div class="admin-menu-item" data-tab="settings">
          <i>âš™ï¸</i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </div>
      </div>
      <div class="admin-logout" id="admin-logout">Ø®Ø±ÙˆØ¬</div>
    </div>
    <div class="admin-content">
      <!-- Admin dashboard tab -->
      <div id="admin-dashboard-tab" class="admin-tab active">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
        <div class="admin-stats-grid">
          <div class="stat-box">
            <div class="stat-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±</div>
            <div class="stat-value" id="total-visitors">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="stat-value" id="total-students">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-title">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</div>
            <div class="stat-value" id="total-uploaded-exams">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-title">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…</div>
            <div class="stat-value" id="total-exam-hours">0</div>
          </div>
        </div>
        <div style="margin-top:30px;text-align:center;">
          <button class="btn" id="show-downloads">Ø¹Ø±Ø¶ Ø§Ù„ØªØ²ÙŠÙŠÙ„Ø§Øª</button>
        </div>
      </div>
      <div id="admin-students-tab" class="admin-tab">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
        <div class="students-list" id="students-list"></div>
      </div>
      <div id="admin-subjects-tab" class="admin-tab">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
        <div class="input-group" style="max-width:300px;margin:20px auto;">
          <select id="admin-branch-selector">
            <option value="business">Ø£Ø¹Ù…Ø§Ù„</option>
            <option value="systems">Ù†Ø¸Ù…</option>
          </select>
        </div>
        <div id="admin-subjects" class="subjects-grid"></div>
      </div>
      <div id="admin-exams-tab" class="admin-tab">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
        <div class="exam-management-layout">
          <div class="subjects-panel" id="exam-subjects-panel">
            <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</h3>
            <div class="input-group">
              <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
              <select id="exam-branch-selector">
                <option value="business">Ø£Ø¹Ù…Ø§Ù„</option>
                <option value="systems">Ù†Ø¸Ù…</option>
              </select>
            </div>
            <div id="exam-subjects-list"></div>
          </div>
          <div class="questions-panel" id="exam-questions-panel">
            <h3 id="current-subject-title">Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ù…Ø§Ø¯Ø©: ...</h3>
            <div id="questions-container"></div>
            <button class="btn add-question-btn" id="add-question">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
            <button class="btn upload-exam-btn" id="upload-exam">Ø±ÙØ¹ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
          </div>
        </div>
      </div>
      <div id="admin-uploaded-exams-tab" class="admin-tab">
        <h2>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</h2>
        <div id="uploaded-exams-list" class="uploaded-exams-list"></div>
        <div id="exam-view-inline" class="exam-view-inline hidden"></div>
      </div>
      <div id="admin-reports-tab" class="admin-tab">
        <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
        <button class="btn" id="export-grades">ØªØµØ¯ÙŠØ± Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (CSV)</button>
        <button class="btn" id="export-passed">ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø§Ø¬Ø­ÙŠÙ† (CSV)</button>
        <button class="btn" id="export-stats">ØªØµØ¯ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¬Ø§Ø­ (CSV)</button>
      </div>
      <div id="admin-logs-tab" class="admin-tab">
        <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
        <table class="logs-table" id="logs-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
              <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
              <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="logs-table-body"></tbody>
        </table>
      </div>
      <div id="admin-settings-tab" class="admin-tab">
        <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
        <div class="settings-grid">
          <div class="setting-card">
            <h3>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h3>
            <label class="switch">
              <input type="checkbox" id="setting-enable-exams">
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-card">
            <h3>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h3>
            <label class="switch">
              <input type="checkbox" id="setting-notifications">
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-card">
            <h3>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</h3>
            <label class="switch">
              <input type="checkbox" id="setting-dark-mode" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-card">
            <h3>Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©</h3>
            <label class="switch">
              <input type="checkbox" id="setting-animated-bg" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-card">
            <button class="btn" id="btn-clear-data">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <small style="color: #ff6b6b; display: block; margin-top: 8px;">(Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø·)</small>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="countdown-overlay" id="countdown-overlay">
    <h2>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
    <div class="countdown-number" id="countdown-num">3</div>
  </div>
  <div class="toast" id="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</div>
  <script>
    // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===
    const ADMEN_USERNAME = 'admen';
    const ADMEN_PASSWORD = 'Amr1221@gmail.com';
    const BUSINESS_SUBJECTS = [
      "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª ÙˆØ³Ù„Ø§Ø³Ù„ Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯",
      "Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„",
      "Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ",
      "Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠ",
      "Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„ØªÙˆØ«ÙŠÙ‚"
    ];
    const SYSTEMS_SUBJECTS = [
      "Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„",
      "Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (1)",
      "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬",
      "Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª",
      "ØªØµÙ…ÙŠÙ… Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ø³Ø¨"
    ];
    let SUBJECT_EXAMS = {
      business: {
        "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª ÙˆØ³Ù„Ø§Ø³Ù„ Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯": { enabled: false, exams: [] },
        "Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„": { enabled: false, exams: [] },
        "Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ": { enabled: false, exams: [] },
        "Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠ": { enabled: false, exams: [] },
        "Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„ØªÙˆØ«ÙŠÙ‚": { enabled: false, exams: [] }
      },
      systems: {
        "Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„": { enabled: false, exams: [] },
        "Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (1)": { enabled: false, exams: [] },
        "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬": { enabled: false, exams: [] },
        "Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª": { enabled: false, exams: [] },
        "ØªØµÙ…ÙŠÙ… Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ø³Ø¨": { enabled: false, exams: [] }
      }
    };
    let currentScreen = 'auth-screen';
    let currentUser = null;
    let currentExamSubject = null;
    let examTimer = null;
    let examTimeLeft = 25 * 60;
    let examAnswers = {};
    let examStarted = false;
    let completedExams = JSON.parse(localStorage.getItem('completedExams') || '{}');

    // === Ø£ØµÙˆØ§Øª ===
    function playSound(base64) {
      const audio = new Audio(`data:audio/wav;base64,${base64}`);
      audio.play().catch(() => {});
    }
    const SELECT_SOUND = "UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";
    const COUNTDOWN_SOUND = "UklGRnoAAABXQVZFZm10IBAAAAABAAEA3NkAAIHZAQACABAAZGF0YQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAgADAAQABQAGAAcACAAJAAoACwAMAA0ADgAPABAAEQASABMAFAAVABYAFwAYABkAGgAbABwAHQAeAB8AIAAhACIAIwAkACUAJgAnACgAKQAqACsALAAtAC4ALwAwADEAMgAzADQANQA2ADcAOAA5ADoAOwA8AD0APgA/AEAAQQBCAEMAQwBEAEUARgBHAEgASQBKAEsATABNAE4ATwBQAFEAUgBTAFQAVQBWAFcAWABZAFoAWwBcAF0AXgBfAGAAYQBiAGMAZABlAGYAZwBoAGkAagBrAGwAbQBuAG8AcABxAHIAcwB0AHUAdgB3AHgAeQB6AHsAfAB9AH4AfwCAAIEAggCDAIQAhQCGAIcAiACJAIoAiwCMAI0AjgCPAJAAkQCSAJMAlACVAJYAlwCYAJkAmgCbAJwAnQCeAJ8AoAChAKIAowCkAKUApgCnAKgAqQCqAKsArACtAK4ArwCwALEAsgCzALQAtQC2ALcAuAC5ALoAuwC8AL0AvgC/AMAAwQDCAMMAxADFAMYAxwDIAMkAygDLAMwAzQDOAM8A0ADRANIA0wDUANUA1gDXANgA2QDaANsA3ADdAN4A3wDgAOEA4gDjAOQA5QDmAOcA6ADpAOoA6wDsAO0A7gDvAPAA8QDyAPMA9AD1APYA9wD4APkA+gD7APwA/QD+AP8BAAEBAQIBAwEEAQUBBgEHAQgBCQEKAQsBDAENAQ4BDwEQAREBEgETARQBFQEWARcBGAEZARoBGwEcAR0BHgEfASABIQEiASMBJAElASYBJwEoASkBKgErASwBLQEuAS8BMAExATIBMwE0ATUBNgE3ATgBOQE6ATsBPAE9AT4BPwFAAUEBQgFDAUQBRQFGAUcBSAFJAUoBSwFMAU0BTgFPAVABUQFSAVMBVAFVAVYBVwFYAVkBWgFbAVwBXQFeAV8BYAFhAWIBYwFkAWUBZgFnAWgBaQFqAWsBbAFtAW4BbwFwAXEBcgFzAXQBdQF2AXcBeAF5AXoBewF8AX0BfgF/AYABgQGCAYMBhAGFAYYBhwGIAckBygHLAcwBzQHOAc8B0AHRAdIB0wHUAdUB1gDXAdgB2QHaAdsB3AHdAd4B3wHgAeEB4gHjAeQB5QHmAecB6AHpAeoB6wHsAe0B7gHvAfAB8QHyAfMB9AH1AfYA9wD4APkA+gD7APwA/QD+Af8CAAIBAgICAwIEAgUCBgIHAggCCQIKAgsCDAIN";
    const SUBMIT_SOUND = "UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";
    function playSelectSound() { playSound(SELECT_SOUND); }
    function playCountdownSound() { playSound(COUNTDOWN_SOUND); }
    function playSubmitSound() { playSound(SUBMIT_SOUND); }

    // === Captcha ===
    function generateCaptcha() {
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let captcha = '';
      for (let i = 0; i < 5; i++) {
        captcha += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return captcha;
    }
    let registerCaptcha = '';
    function setupRegisterCaptcha() {
      registerCaptcha = generateCaptcha();
      document.getElementById('register-captcha-display').textContent = registerCaptcha;
      setInterval(() => {
        registerCaptcha = generateCaptcha();
        document.getElementById('register-captcha-display').textContent = registerCaptcha;
      }, 25000);
    }

    // === Ø£Ø¯ÙˆØ§Øª ===
    function trackVisitor() {
      const visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
      const today = new Date().toISOString().split('T')[0];
      if (!visitors.includes(today)) {
        visitors.push(today);
        localStorage.setItem('visitors', JSON.stringify(visitors));
      }
    }
    function generateMockIP() {
      return `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
    }
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(16);
    }
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
    function switchScreen(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      const screenEl = document.getElementById(screenId);
      if (!screenEl) return;
      screenEl.classList.add('active');
      currentScreen = screenId;
      const navBar = document.querySelector('.nav-bar');
      if (navBar) {
        navBar.style.display = (screenId === 'admin-dashboard') ? 'none' : 'flex';
      }
      if (screenId === 'student-dashboard' && currentUser) {
        renderStudentDashboard();
      } else if (screenId === 'results-screen' && currentUser) {
        renderResults();
      } else if (screenId === 'notes-screen' && currentUser) {
        renderNotes();
      } else if (screenId === 'profile-screen' && currentUser) {
        renderProfile();
      } else if (screenId === 'certificates-screen' && currentUser) {
        renderCertificatesScreen();
      } else if (screenId === 'admin-dashboard') {
        renderAdminDashboard();
      }
      updateLastSeen();
    }
    function updateLastSeen() {
      if (currentUser && currentUser.username !== ADMEN_USERNAME) {
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        if (users[currentUser.username]) {
          users[currentUser.username].lastSeen = new Date().toISOString();
          localStorage.setItem('users', JSON.stringify(users));
        }
      }
    }
    function saveToStorage(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }
    function loadFromStorage(key) {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : null;
    }
    function initApp() {
      trackVisitor();
      setupRegisterCaptcha();
      checkAuthAndRedirect();
      applyTheme();
    }
    function checkAuthAndRedirect() {
      const auth = loadFromStorage('auth');
      if (auth && auth.username) {
        currentUser = { username: auth.username };
        if (auth.username === ADMEN_USERNAME) {
          switchScreen('admin-dashboard');
        } else {
          const users = loadFromStorage('users') || {};
          if (users[auth.username]) {
            switchScreen('student-dashboard');
          } else {
            switchScreen('auth-screen');
          }
        }
      } else {
        switchScreen('auth-screen');
      }
    }
    function isValidPassword(pwd) {
      return pwd.length >= 8 && /[a-zA-Z]/.test(pwd) && /\d/.test(pwd);
    }

    // === Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ ===
    function renderSubjects(branch, containerId, clickable = true) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const subjects = branch === 'business' ? BUSINESS_SUBJECTS : SYSTEMS_SUBJECTS;
      const examsMap = SUBJECT_EXAMS[branch];
      subjects.forEach(subject => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        const subjectData = examsMap[subject];
        const userNewExams = loadFromStorage('userNewExams') || {};
        const examKey = `${branch}-${subject}`;
        let hasNew = subjectData.enabled && subjectData.exams.length > 0;
        if (hasNew) {
          const seen = userNewExams[currentUser?.username]?.[examKey] || [];
          hasNew = subjectData.exams.length !== seen.length;
        }
        const userCompleted = JSON.parse(localStorage.getItem('completedExams') || '{}')[currentUser?.username] || {};
        let allCompleted = false;
        if (subjectData.enabled && subjectData.exams.length > 0) {
          allCompleted = subjectData.exams.every((_, idx) => {
            const key = `${branch}-${subject}-exam${idx}`;
            return userCompleted[key] === 'completed';
          });
        }
        if (!subjectData || !subjectData.enabled) {
          card.classList.add('disabled');
          card.innerHTML = `
            <h3>${subject}</h3>
            <span class="lock-icon"></span>
            <div class="activation-message">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚ÙØ¨Ù„ Ø§Ù„Ù…Ø·ÙˆØ± Amr Lotfy Ø¹Ù†Ø¯ ØªÙˆØ§Ø¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†.</div>
          `;
          if (clickable) {
            card.addEventListener('click', () => card.classList.toggle('clicked'));
          }
        } else {
          let content = `<h3>${subject}</h3>`;
          if (hasNew && !allCompleted) {
            content += `<span style="position:absolute;top:10px;right:10px;width:12px;height:12px;background:red;border-radius:50%;"></span>`;
          }
          if (allCompleted) {
            card.classList.add('completed');
            content += `<div class="exclamation-icon">â—</div>`;
            content += `<div class="completion-message">Ø³ÙŠØªÙ… ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ù†Ø²ÙˆÙ„ Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯. Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø¬ØªÙ‡Ø§Ø¯Ùƒ!</div>`;
          }
          if (subjectData.exams.length === 0) {
            content += `<p style="color:#f87171;margin-top:10px;font-size:14px;">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù„Ø³Ù‡ Ù…Ù†Ø²Ù„Ø´. ØªØ·ÙˆÙŠØ± Amr Lotfy</p>`;
            card.innerHTML = content;
          } else {
            card.innerHTML = content;
            if (clickable) {
              if (allCompleted) {
                card.addEventListener('click', () => card.classList.toggle('clicked'));
              } else {
                card.onclick = () => showExamList(subject, branch);
              }
            }
          }
        }
        container.appendChild(card);
      });
    }

    // === Ø¥Ù†Ø´Ø§Ø¡ Ø´Ù‡Ø§Ø¯Ø© ===
    function generateCertificate(result) {
      const users = loadFromStorage('users') || {};
      const user = users[currentUser.username];
      const username = user.username;
      const subject = result.subject;
      const percentage = result.percentage;
      const correct = result.correct;
      const total = result.total;
      const grade = result.grade;
      const incorrect = total - correct;
      const message = percentage >= 90 ? 'Ø£Ø­Ø³Ù†Øª! Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø².' :
                      percentage >= 80 ? 'Ù…Ù…ØªØ§Ø²! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ…ÙŠØ².' :
                      percentage >= 70 ? 'Ø¹Ù…Ù„ Ø¬ÙŠØ¯ØŒ Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªØ­Ø³Ù†.' :
                      percentage >= 60 ? 'Ù„Ù‚Ø¯ Ù†Ø¬Ø­Øª! Ø­Ø§ÙˆÙ„ Ø£Ù† ØªØªØ­Ø³Ù† Ø£ÙƒØ«Ø±.' :
                      'ØªØ­ØªØ§Ø¬ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£ÙƒØ«Ø± ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©. Ù„Ø§ ØªØ³ØªØ³Ù„Ù…!';
      const cert = {
        id: Date.now(),
        username,
        subject,
        percentage,
        correct,
        incorrect,
        total,
        grade,
        message,
        date: new Date().toISOString()
      };
      const certs = loadFromStorage('userCertificates') || {};
      if (!certs[currentUser.username]) certs[currentUser.username] = [];
      certs[currentUser.username].push(cert);
      saveToStorage('userCertificates', certs);
    }

    // === Ø±Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¹Ù„Ù‰ Canvas ===
    function drawCertificateOnCanvas(canvas, cert) {
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, w, h);
      ctx.strokeStyle = '#1e3a8a';
      ctx.lineWidth = 8;
      ctx.strokeRect(10, 10, w - 20, h - 20);
      ctx.font = 'bold 36px Arial';
      ctx.fillStyle = '#1e40af';
      ctx.textAlign = 'center';
      ctx.fillText('Mora Test', w / 2, 80);
      ctx.font = 'bold 28px Arial';
      ctx.fillStyle = '#000000';
      ctx.fillText('Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±', w / 2, 140);
      ctx.font = '20px Arial';
      ctx.fillText('Ù†ÙÙ‚Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù„Ù‰', w / 2, 200);
      ctx.font = 'bold 32px Arial';
      ctx.fillStyle = '#1e3a8a';
      ctx.fillText(cert.username, w / 2, 260);
      ctx.font = '18px Arial';
      ctx.fillStyle = '#000000';
      ctx.fillText(`Ù„Ø¥ØªÙ…Ø§Ù…Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ù…Ø§Ø¯Ø©: ${cert.subject}`, w / 2, 320);
      ctx.fillText(`Ø¨Ø¹Ø¯Ø¯ Ø£Ø³Ø¦Ù„Ø©: ${cert.total}`, w / 2, 360);
      ctx.fillText(`Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${cert.correct}`, w / 2, 400);
      ctx.fillText(`Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: ${cert.percentage}%`, w / 2, 440);
      ctx.fillText(`Ø§Ù„ØªÙ‚Ø¯ÙŠØ±: ${cert.grade}`, w / 2, 480);
      ctx.font = 'italic 18px Arial';
      ctx.fillText(`"${cert.message}"`, w / 2, 540);
      // ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© "Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ©"
      ctx.font = '14px Arial';
      ctx.fillStyle = '#64748b';
      ctx.textAlign = 'left';
      ctx.fillText('Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ©', 80, h - 110);
      ctx.font = 'bold 22px Arial';
      ctx.fillStyle = '#000000';
      ctx.fillText('Amr Lotfy', 80, h - 80);
      ctx.font = '14px Arial';
      ctx.fillStyle = '#64748b';
      ctx.textAlign = 'right';
      ctx.fillText(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${new Date(cert.date).toLocaleDateString('ar-EG')}`, w - 80, h - 80);
    }

    // === ØªØ­Ù…ÙŠÙ„ PDF ===
    function downloadCertificateAsPDF(canvas, filename) {
      const imgData = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = imgData;
      link.download = filename + '.png'; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Ù†Ø¸Ø±Ø§Ù‹ Ù„ØªØ¹Ù‚ÙŠØ¯ PDF
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);
    }

    // === Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ===
    function renderCertificatesScreen() {
      const certs = loadFromStorage('userCertificates') || {};
      const userCerts = certs[currentUser?.username] || [];
      const list = document.getElementById('certificates-list');
      list.innerHTML = '';
      if (userCerts.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#aaa;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø£ÙƒÙ…Ù„ Ø§Ù…ØªØ­Ø§Ù†Ù‹Ø§ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰!</p>';
        return;
      }
      userCerts.forEach((cert, idx) => {
        const container = document.createElement('div');
        container.className = 'certificate-container';
        const canvas = document.createElement('canvas');
        canvas.className = 'certificate-canvas';
        canvas.width = 700;
        canvas.height = 600;
        drawCertificateOnCanvas(canvas, cert);
        const actions = document.createElement('div');
        actions.className = 'certificate-actions';
        const btn = document.createElement('button');
        btn.className = 'btn-download-pdf';
        btn.textContent = 'ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ ØµÙˆØ±Ø©';
        btn.onclick = () => downloadCertificateAsPDF(canvas, `Certificate-${cert.id}`);
        actions.appendChild(btn);
        container.appendChild(canvas);
        container.appendChild(actions);
        list.appendChild(container);
      });
    }

    // === Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ===
    function showExamList(subject, branch) {
      const examListEl = document.getElementById('exam-list-screen');
      const exams = SUBJECT_EXAMS[branch][subject].exams;
      let html = `<h2 style="text-align:center;">${subject}</h2><div style="margin-top:20px;">`;
      const userCompleted = JSON.parse(localStorage.getItem('completedExams') || '{}')[currentUser.username] || {};
      const userNewExams = loadFromStorage('userNewExams') || {};
      const examKey = `${branch}-${subject}`;
      let seen = userNewExams[currentUser.username]?.[examKey] || [];
      exams.forEach((exam, idx) => {
        const examId = `${examKey}-exam${idx}`;
        const completed = userCompleted[examId] === 'completed';
        html += `
          <div class="form-container" style="margin:15px auto;${completed ? 'opacity:0.7;' : ''}">
            <h3>Ø§Ù…ØªØ­Ø§Ù† ${idx + 1}</h3>
            <p>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${exam.questions.length}</p>
            ${completed ? '<p style="color:#34d399;">âœ“ Ø£ÙƒÙ…Ù„ØªÙ‡ Ø¨Ø§Ù„ÙØ¹Ù„</p>' : ''}
            <button class="btn" ${completed ? 'disabled' : ''} onclick="startSpecificExam('${subject}', '${branch}', ${idx})">
              ${completed ? 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' : 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†'}
            </button>
          </div>
        `;
        if (!seen.includes(idx)) seen.push(idx);
      });
      if (!userNewExams[currentUser.username]) userNewExams[currentUser.username] = {};
      userNewExams[currentUser.username][examKey] = seen;
      saveToStorage('userNewExams', userNewExams);
      html += `</div><button class="btn btn-danger" style="margin:20px auto;display:block;width:200px;" onclick="switchScreen('student-dashboard')">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>`;
      examListEl.innerHTML = html;
      switchScreen('exam-list-screen');
    }

    function startSpecificExam(subject, branch, examIndex) {
      currentExamSubject = { name: subject, branch, examIndex };
      document.getElementById('intro-subject-name').textContent = `${subject} - Ø§Ù…ØªØ­Ø§Ù† ${examIndex + 1}`;
      switchScreen('exam-intro');
    }

    function startCountdown(callback) {
      let count = 3;
      const countdownEl = document.getElementById('countdown-num');
      const overlay = document.getElementById('countdown-overlay');
      overlay.classList.add('active');
      const interval = setInterval(() => {
        playCountdownSound();
        countdownEl.textContent = count;
        if (count === 0) {
          clearInterval(interval);
          overlay.classList.remove('active');
          callback();
        }
        count--;
      }, 1000);
    }

    function beginExam() {
      const { name: subject, branch, examIndex } = currentExamSubject;
      const exam = SUBJECT_EXAMS[branch][subject].exams[examIndex];
      examTimeLeft = 25 * 60;
      examAnswers = {};
      examStarted = true;
      const examContent = document.getElementById('exam-content');
      examContent.innerHTML = '';
      exam.questions.forEach((q, idx) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        questionDiv.innerHTML = `<h3>${q.text}</h3>`;
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        q.options.forEach((opt, optIdx) => {
          const optDiv = document.createElement('div');
          optDiv.className = 'option';
          optDiv.textContent = opt;
          optDiv.onclick = () => {
            playSelectSound();
            document.querySelectorAll(`.question:nth-child(${idx + 1}) .option`).forEach(o => o.classList.remove('selected'));
            optDiv.classList.add('selected');
            examAnswers[q.id] = optIdx;
            checkAllAnsweredForCurrentExam();
          };
          optionsDiv.appendChild(optDiv);
        });
        questionDiv.appendChild(optionsDiv);
        examContent.appendChild(questionDiv);
      });
      checkAllAnsweredForCurrentExam();
      startExamTimer();
      switchScreen('exam-screen');
      const userExams = completedExams[currentUser.username] || {};
      const examKey = `${branch}-${subject}-exam${examIndex}`;
      userExams[examKey] = 'started';
      completedExams[currentUser.username] = userExams;
      saveToStorage('completedExams', completedExams);
    }

    function checkAllAnsweredForCurrentExam() {
      const { name: subject, branch, examIndex } = currentExamSubject;
      const exam = SUBJECT_EXAMS[branch][subject].exams[examIndex];
      const allAnswered = exam.questions.every(q => examAnswers.hasOwnProperty(q.id));
      document.getElementById('btn-submit-exam').disabled = !allAnswered;
    }

    function startExamTimer() {
      if (examTimer) clearInterval(examTimer);
      examTimer = setInterval(() => {
        examTimeLeft--;
        const mins = Math.floor(examTimeLeft / 60);
        const secs = examTimeLeft % 60;
        document.getElementById('exam-timer').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        if (examTimeLeft <= 0) {
          clearInterval(examTimer);
          submitExam();
        }
      }, 1000);
    }

    function submitExam() {
      if (examTimer) clearInterval(examTimer);
      playSubmitSound();
      const { name: subject, branch, examIndex } = currentExamSubject;
      const exam = SUBJECT_EXAMS[branch][subject].exams[examIndex];
      let correct = 0;
      exam.questions.forEach(q => {
        if (examAnswers[q.id] === q.correct) correct++;
      });
      const total = exam.questions.length;
      const percentage = Math.round((correct / total) * 100);
      let grade = percentage >= 90 ? 'Ù…Ù…ØªØ§Ø²' :
                  percentage >= 80 ? 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§' :
                  percentage >= 70 ? 'Ø¬ÙŠØ¯' :
                  percentage >= 60 ? 'Ù…Ù‚Ø¨ÙˆÙ„' : 'Ø¶Ø¹ÙŠÙ';
      let message = percentage >= 90 ? 'Ø£Ø­Ø³Ù†Øª! Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø².' :
                   percentage >= 80 ? 'Ù…Ù…ØªØ§Ø²! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ…ÙŠØ².' :
                   percentage >= 70 ? 'Ø¹Ù…Ù„ Ø¬ÙŠØ¯ØŒ Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªØ­Ø³Ù†.' :
                   percentage >= 60 ? 'Ù„Ù‚Ø¯ Ù†Ø¬Ø­Øª! Ø­Ø§ÙˆÙ„ Ø£Ù† ØªØªØ­Ø³Ù† Ø£ÙƒØ«Ø±.' :
                   'ØªØ­ØªØ§Ø¬ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£ÙƒØ«Ø± ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©. Ù„Ø§ ØªØ³ØªØ³Ù„Ù…!';
      const results = loadFromStorage('examResults') || {};
      if (!results[currentUser.username]) results[currentUser.username] = [];
      const resultEntry = {
        subject,
        examIndex,
        date: new Date().toISOString(),
        correct,
        total,
        percentage,
        grade
      };
      results[currentUser.username].push(resultEntry);
      saveToStorage('examResults', results);
      generateCertificate(resultEntry);
      const userExams = completedExams[currentUser.username] || {};
      const examKey = `${branch}-${subject}-exam${examIndex}`;
      userExams[examKey] = 'completed';
      completedExams[currentUser.username] = userExams;
      saveToStorage('completedExams', completedExams);
      const allDone = SUBJECT_EXAMS[branch][subject].exams.every((_, i) => {
        const key = `${branch}-${subject}-exam${i}`;
        return userExams[key] === 'completed';
      });
      const resultSummary = document.getElementById('result-summary');
      resultSummary.innerHTML = `
        <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correct}</p>
        <p>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: ${percentage}%</p>
        <p>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±: ${grade}</p>
        <div class="results-message">${message}</div>
        ${allDone ? '<p style="color:#4caf50;font-weight:bold;margin-top:15px;">Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­</p>' : ''}
      `;
      switchScreen('exam-result');
    }

    function renderStudentDashboard() {
      const users = loadFromStorage('users') || {};
      const user = users[currentUser.username];
      renderSubjects(user.branch, 'student-subjects', true);
    }

    function renderResults() {
      const resultsContainer = document.getElementById('results-list');
      const results = loadFromStorage('examResults') || {};
      const userResults = results[currentUser.username] || [];
      if (userResults.length === 0) {
        resultsContainer.innerHTML = '<p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø£ÙŠ Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¹Ø¯.</p>';
        return;
      }
      let html = '';
      userResults.forEach(r => {
        const date = new Date(r.date).toLocaleDateString('ar-EG');
        html += `
          <div class="form-container">
            <h3>${r.subject} ${r.examIndex !== undefined ? `- Ø§Ù…ØªØ­Ø§Ù† ${r.examIndex + 1}` : ''}</h3>
            <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}</p>
            <p>Ø§Ù„Ø¯Ø±Ø¬Ø©: ${r.percentage}% (${r.grade})</p>
            <p>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${r.correct}/${r.total}</p>
          </div>
        `;
      });
      resultsContainer.innerHTML = html;
    }

    function renderNotes() {
      const notes = loadFromStorage('userNotes') || {};
      document.getElementById('user-notes').value = notes[currentUser.username] || '';
    }

    function renderProfile() {
      const users = loadFromStorage('users') || {};
      const user = users[currentUser.username];
      document.getElementById('profile-display-username').textContent = user.username;
      document.getElementById('profile-display-branch').textContent = user.branch === 'business' ? 'Ø£Ø¹Ù…Ø§Ù„' : 'Ù†Ø¸Ù…';
      document.getElementById('profile-display-registered').textContent = new Date(user.registered).toLocaleDateString('ar-EG');
      document.getElementById('profile-display-last-seen').textContent = user.lastSeen ? new Date(user.lastSeen).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
      const results = loadFromStorage('examResults') || {};
      const examsCount = results[currentUser.username] ? results[currentUser.username].length : 0;
      document.getElementById('profile-display-exams').textContent = examsCount;
    }

    function renderAdminDashboard() {
      document.querySelectorAll('.admin-menu-item').forEach(item => {
        item.onclick = function() {
          document.querySelectorAll('.admin-menu-item').forEach(el => el.classList.remove('active'));
          this.classList.add('active');
          const tab = this.getAttribute('data-tab');
          document.querySelectorAll('.admin-tab').forEach(el => {
            el.classList.remove('active');
            el.style.display = 'none';
          });
          const targetTab = document.getElementById(`admin-${tab}-tab`);
          targetTab.classList.add('active');
          targetTab.style.display = 'block';
          if (tab === 'exams') {
            renderExamManagement();
          } else if (tab === 'uploaded-exams') {
            renderUploadedExams();
          } else if (tab === 'logs') {
            renderLogs();
          } else if (tab === 'dashboard') {
            updateDashboardStats();
          } else if (tab === 'settings') {
            renderSettings();
          }
        };
      });
      document.getElementById('admin-logout').onclick = function() {
        localStorage.removeItem('auth');
        currentUser = null;
        switchScreen('auth-screen');
      };
      updateDashboardStats();
      renderStudentsList();
      document.getElementById('admin-branch-selector').onchange = function() {
        renderSubjects(this.value, 'admin-subjects', false);
        const container = document.getElementById('admin-subjects');
        const subjects = this.value === 'business' ? BUSINESS_SUBJECTS : SYSTEMS_SUBJECTS;
        Array.from(container.children).forEach((card, idx) => {
          const subject = subjects[idx];
          const exam = SUBJECT_EXAMS[this.value][subject];
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.style.marginTop = '10px';
          btn.textContent = exam.enabled ? 'ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©';
          btn.onclick = () => {
            exam.enabled = !exam.enabled;
            SUBJECT_EXAMS[this.value][subject] = exam;
            saveToStorage('subjectExams', SUBJECT_EXAMS);
            renderAdminDashboard();
          };
          card.appendChild(btn);
        });
      };
      document.getElementById('admin-branch-selector').value = 'business';
      document.getElementById('admin-branch-selector').dispatchEvent(new Event('change'));
      document.getElementById('export-grades').onclick = () => exportGrades();
      document.getElementById('export-passed').onclick = () => exportPassed();
      document.getElementById('export-stats').onclick = () => exportStats();
      document.getElementById('show-downloads').onclick = () => {
        alert('Ø¹Ø¯Ø¯ ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: 0 (ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)');
      };
      document.querySelector('.admin-menu-item[data-tab="dashboard"]').click();
    }

    function renderSettings() {
      const settings = loadFromStorage('appSettings') || {
        enableExams: true,
        notifications: true,
        darkMode: true,
        animatedBg: true
      };
      document.getElementById('setting-enable-exams').checked = settings.enableExams;
      document.getElementById('setting-notifications').checked = settings.notifications;
      document.getElementById('setting-dark-mode').checked = settings.darkMode;
      document.getElementById('setting-animated-bg').checked = settings.animatedBg;
      document.getElementById('setting-enable-exams').onchange = saveSettings;
      document.getElementById('setting-notifications').onchange = saveSettings;
      document.getElementById('setting-dark-mode').onchange = saveSettings;
      document.getElementById('setting-animated-bg').onchange = saveSettings;
      document.getElementById('btn-clear-data').onclick = function() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!')) {
          localStorage.clear();
          location.reload();
        }
      };
    }

    function saveSettings() {
      const settings = {
        enableExams: document.getElementById('setting-enable-exams').checked,
        notifications: document.getElementById('setting-notifications').checked,
        darkMode: document.getElementById('setting-dark-mode').checked,
        animatedBg: document.getElementById('setting-animated-bg').checked
      };
      saveToStorage('appSettings', settings);
      applyTheme();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    }

    function applyTheme() {
      const settings = loadFromStorage('appSettings') || { darkMode: true, animatedBg: true };
      const body = document.body;
      body.classList.remove('dark-mode', 'light-mode');
      if (settings.darkMode) {
        body.classList.add('dark-mode');
      } else {
        body.classList.add('light-mode');
      }
      if (!settings.animatedBg) {
        body.style.background = '';
        body.style.setProperty('--bg', 'rgba(240, 248, 255, 0.8)');
      } else {
        if (settings.darkMode) {
          body.style.background = 'linear-gradient(135deg, #0f172a, #1e293b)';
        } else {
          body.style.background = 'linear-gradient(135deg, #e0f7fa, #bbdefb)';
        }
      }
    }

    function updateDashboardStats() {
      const users = loadFromStorage('users') || {};
      const totalStudents = Object.keys(users).filter(u => u !== ADMEN_USERNAME).length;
      const visitors = loadFromStorage('visitors') ? JSON.parse(localStorage.getItem('visitors')).length : 0;
      let uploadedExams = 0;
      Object.values(SUBJECT_EXAMS).forEach(branch => {
        Object.values(branch).forEach(exam => {
          if (exam.enabled && exam.exams.length > 0) {
            uploadedExams += exam.exams.length;
          }
        });
      });
      const examHours = loadFromStorage('totalExamHours') || 0;
      document.getElementById('total-visitors').textContent = visitors;
      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('total-uploaded-exams').textContent = uploadedExams;
      document.getElementById('total-exam-hours').textContent = Math.round(examHours * 100) / 100;
    }

    function renderStudentsList() {
      const users = loadFromStorage('users') || {};
      const results = loadFromStorage('examResults') || {};
      const studentsList = document.getElementById('students-list');
      studentsList.innerHTML = '';
      Object.keys(users).forEach(username => {
        if (username === ADMEN_USERNAME) return;
        const u = users[username];
        const examsCount = results[username] ? results[username].length : 0;
        const ip = u.ip || 'unknown';
        const plainPassword = u.plainPassword || 'â€”';
        const registered = new Date(u.registered).toLocaleString('ar-EG');
        const studentCard = document.createElement('div');
        studentCard.className = 'student-card';
        const isBanned = u.banned || false;
        const isIPBanned = u.ipBanned || false;
        studentCard.innerHTML = `
          <div class="student-header">
            <div>
              <div class="student-name">${username} ${isBanned ? 'ğŸ›¡ï¸' : ''}</div>
              <div class="student-location">${u.branch === 'business' ? 'Ø£Ø¹Ù…Ø§Ù„' : 'Ù†Ø¸Ù…'}, EG</div>
            </div>
          </div>
          <div class="student-details">
            <div class="detail-item"><span class="detail-label">ID:</span> <span class="detail-value">${username}</span></div>
            <div class="detail-item"><span class="detail-label">IP:</span> <span class="detail-value">${ip}</span></div>
            <div class="detail-item"><span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span> <span class="detail-value">${registered}</span></div>
            <div class="detail-item"><span class="detail-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</span> <span class="detail-value">${plainPassword}</span></div>
            <div class="detail-item"><span class="detail-label">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª:</span> <span class="detail-value">${examsCount}</span></div>
            <div class="detail-item"><span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span class="detail-value">${isBanned ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ù†Ø´Ø·'}</span></div>
          </div>
          <div class="student-actions">
            <button class="btn-action btn-delete" onclick="deleteStudent('${username}')">Ø­Ø°Ù</button>
            <button class="btn-action ${isBanned ? 'btn-unban' : 'btn-ban'}" onclick="toggleBanStudent('${username}')">${isBanned ? 'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}</button>
            <button class="btn-action ${isIPBanned ? 'btn-ip-unban' : 'btn-ip-ban'}" onclick="toggleBanIP('${username}')">${isIPBanned ? 'ÙÙƒ Ø­Ø¸Ø± IP' : 'Ø­Ø¸Ø± IP'}</button>
          </div>
        `;
        studentsList.appendChild(studentCard);
      });
      if (Object.keys(users).filter(u => u !== ADMEN_USERNAME).length === 0) {
        studentsList.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯.</p>';
      }
    }

    window.deleteStudent = function(username) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ "${username}"ØŸ`)) return;
      const users = loadFromStorage('users') || {};
      delete users[username];
      const results = loadFromStorage('examResults') || {};
      delete results[username];
      const completed = loadFromStorage('completedExams') || {};
      delete completed[username];
      const certs = loadFromStorage('userCertificates') || {};
      delete certs[username];
      saveToStorage('users', users);
      saveToStorage('examResults', results);
      saveToStorage('completedExams', completed);
      saveToStorage('userCertificates', certs);
      renderStudentsList();
      showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨');
    };

    window.toggleBanStudent = function(username) {
      const users = loadFromStorage('users') || {};
      if (!users[username]) return;
      users[username].banned = !users[username].banned;
      saveToStorage('users', users);
      renderStudentsList();
      showToast(users[username].banned ? 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø·Ø§Ù„Ø¨' : 'ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø±');
    };

    window.toggleBanIP = function(username) {
      const users = loadFromStorage('users') || {};
      if (!users[username]) return;
      users[username].ipBanned = !users[username].ipBanned;
      saveToStorage('users', users);
      renderStudentsList();
      showToast(users[username].ipBanned ? 'ØªÙ… Ø­Ø¸Ø± IP' : 'ØªÙ… ÙÙƒ Ø­Ø¸Ø± IP');
    };

    function renderExamManagement() {
      const branchSelector = document.getElementById('exam-branch-selector');
      const subjectsList = document.getElementById('exam-subjects-list');
      const questionsPanel = document.getElementById('exam-questions-panel');
      branchSelector.onchange = function() {
        subjectsList.innerHTML = '';
        questionsPanel.classList.remove('active');
        const subjects = this.value === 'business' ? BUSINESS_SUBJECTS : SYSTEMS_SUBJECTS;
        subjects.forEach(subject => {
          const div = document.createElement('div');
          div.className = 'subject-card';
          div.innerHTML = `<h3>${subject}</h3>`;
          div.onclick = () => {
            openExamCreationForm(this.value, subject);
          };
          subjectsList.appendChild(div);
        });
      };
      branchSelector.value = 'business';
      branchSelector.dispatchEvent(new Event('change'));
    }

    function openExamCreationForm(branch, subject) {
      document.getElementById('current-subject-title').textContent = `Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ù…Ø§Ø¯Ø©: ${subject}`;
      currentExamSubject = { name: subject, branch };
      renderQuestionsForm();
      document.getElementById('exam-questions-panel').classList.add('active');
    }

    function renderQuestionsForm() {
      const container = document.getElementById('questions-container');
      container.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        addQuestion({ id: i+1, text: '', type: 'mcq', options: ['', '', '', ''], correct: 0 }, i);
      }
    }

    function addQuestion(questionData = null, index = null) {
      const container = document.getElementById('questions-container');
      const questionDiv = document.createElement('div');
      questionDiv.className = 'question-item';
      const questionId = questionData ? questionData.id : Date.now() + Math.random();
      const questionText = questionData ? questionData.text : '';
      const questionType = questionData ? questionData.type : 'mcq';
      const options = questionData ? [...questionData.options] : ['', '', '', ''];
      const correct = questionData ? questionData.correct : 0;
      questionDiv.innerHTML = `
        <div class="question-type">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
          <select class="question-type-select">
            <option value="mcq" ${questionType === 'mcq' ? 'selected' : ''}>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
            <option value="truefalse" ${questionType === 'truefalse' ? 'selected' : ''}>ØµØ­ Ø£Ùˆ Ø®Ø·Ø£</option>
            <option value="fill" ${questionType === 'fill' ? 'selected' : ''}>Ø¥ÙƒÙ…Ø§Ù„ ÙØ±Ø§Øº</option>
          </select>
        </div>
        <div class="input-group">
          <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
          <textarea class="question-text" rows="2">${questionText}</textarea>
        </div>
        <div class="options-container">
          ${renderOptions(questionType, options)}
        </div>
        <div class="correct-answer">
          <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label>
          <select class="correct-answer-select">
            ${renderCorrectOptions(questionType, options, correct)}
          </select>
        </div>
        <button class="remove-question">Ã—</button>
      `;
      const typeSelect = questionDiv.querySelector('.question-type-select');
      const optionsContainer = questionDiv.querySelector('.options-container');
      const correctSelect = questionDiv.querySelector('.correct-answer-select');
      const removeBtn = questionDiv.querySelector('.remove-question');
      typeSelect.onchange = function() {
        const newType = this.value;
        let newOptions = ['', '', '', ''];
        if (newType === 'truefalse') newOptions = ['ØµØ­', 'Ø®Ø·Ø£'];
        else if (newType === 'fill') newOptions = [''];
        optionsContainer.innerHTML = renderOptions(newType, newOptions);
        correctSelect.innerHTML = renderCorrectOptions(newType, newOptions, 0);
      };
      removeBtn.onclick = function() {
        container.removeChild(questionDiv);
      };
      container.appendChild(questionDiv);
    }

    function renderOptions(type, options) {
      let html = '';
      if (type === 'mcq') {
        for (let i = 0; i < 4; i++) {
          html += `<div class="option-input"><label>Ø§Ù„Ø®ÙŠØ§Ø± ${String.fromCharCode(65 + i)}:</label><input type="text" class="option-input-field" value="${options[i] || ''}" /></div>`;
        }
      } else if (type === 'truefalse') {
        html = `
          <div class="option-input"><label>Ø§Ù„Ø®ÙŠØ§Ø± 1:</label><input type="text" class="option-input-field" value="${options[0] || ''}" /></div>
          <div class="option-input"><label>Ø§Ù„Ø®ÙŠØ§Ø± 2:</label><input type="text" class="option-input-field" value="${options[1] || ''}" /></div>
        `;
      } else if (type === 'fill') {
        html = `<div class="option-input"><label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</label><input type="text" class="option-input-field" value="${options[0] || ''}" /></div>`;
      }
      return html;
    }

    function renderCorrectOptions(type, options, correct) {
      let html = '';
      if (type === 'mcq') {
        for (let i = 0; i < 4; i++) {
          html += `<option value="${i}" ${i === correct ? 'selected' : ''}>Ø§Ù„Ø®ÙŠØ§Ø± ${String.fromCharCode(65 + i)}</option>`;
        }
      } else if (type === 'truefalse') {
        html = `<option value="0" ${correct === 0 ? 'selected' : ''}>Ø§Ù„Ø®ÙŠØ§Ø± 1</option><option value="1" ${correct === 1 ? 'selected' : ''}>Ø§Ù„Ø®ÙŠØ§Ø± 2</option>`;
      } else if (type === 'fill') {
        html = `<option value="0" selected>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</option>`;
      }
      return html;
    }

    document.getElementById('add-question').onclick = function() {
      addQuestion();
    };

    document.getElementById('upload-exam').onclick = function() {
      const questions = [];
      const questionItems = document.querySelectorAll('.question-item');
      let valid = true;
      questionItems.forEach((item, index) => {
        const type = item.querySelector('.question-type-select').value;
        const text = item.querySelector('.question-text').value.trim();
        const optionInputs = item.querySelectorAll('.option-input-field');
        const options = Array.from(optionInputs).map(input => input.value.trim());
        const correct = parseInt(item.querySelector('.correct-answer-select').value);
        if (!text) {
          valid = false;
          return;
        }
        if (type === 'mcq') {
          if (options.some(opt => !opt)) valid = false;
        } else if (type === 'truefalse') {
          if (!options[0] || !options[1]) valid = false;
        } else if (type === 'fill') {
          if (!options[0]) valid = false;
        }
        questions.push({ id: index + 1, text, type, options, correct });
      });
      if (!valid) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
        return;
      }
      const branch = currentExamSubject.branch;
      const subject = currentExamSubject.name;
      if (!SUBJECT_EXAMS[branch][subject].exams) SUBJECT_EXAMS[branch][subject].exams = [];
      SUBJECT_EXAMS[branch][subject].exams.push({ questions });
      SUBJECT_EXAMS[branch][subject].enabled = true;
      saveToStorage('subjectExams', SUBJECT_EXAMS);
      updateDashboardStats();
      showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­');
      document.getElementById('exam-questions-panel').classList.remove('active');
      renderExamManagement();
    };

    function renderUploadedExams() {
      const uploadedExamsList = document.getElementById('uploaded-exams-list');
      const examViewInline = document.getElementById('exam-view-inline');
      uploadedExamsList.innerHTML = '';
      examViewInline.classList.add('hidden');
      examViewInline.innerHTML = '';
      Object.keys(SUBJECT_EXAMS).forEach(branch => {
        Object.keys(SUBJECT_EXAMS[branch]).forEach(subject => {
          const examData = SUBJECT_EXAMS[branch][subject];
          if (examData.enabled && examData.exams && examData.exams.length > 0) {
            examData.exams.forEach((exam, examIdx) => {
              const item = document.createElement('div');
              item.className = 'uploaded-exam-item';
              item.innerHTML = `
                <div>
                  <strong>${subject}</strong> - ${branch === 'business' ? 'Ø£Ø¹Ù…Ø§Ù„' : 'Ù†Ø¸Ù…'} (Ø§Ù…ØªØ­Ø§Ù† ${examIdx + 1})
                  <br><small>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${exam.questions.length}</small>
                </div>
                <div class="uploaded-exam-actions">
                  <button class="btn-action btn-view" onclick="viewExamInline('${branch}', '${subject}', ${examIdx})">Ø¹Ø±Ø¶</button>
                  <button class="btn-action btn-delete-exam" onclick="deleteSpecificExam('${branch}', '${subject}', ${examIdx})">Ø­Ø°Ù</button>
                </div>
              `;
              uploadedExamsList.appendChild(item);
            });
          }
        });
      });
      if (uploadedExamsList.innerHTML === '') {
        uploadedExamsList.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø±ØªÙØ¹Ø© Ø¨Ø¹Ø¯.</p>';
      }
    }

    window.viewExamInline = function(branch, subject, examIndex) {
      const exam = SUBJECT_EXAMS[branch][subject].exams[examIndex];
      let html = `<h3>${subject} - ${branch === 'business' ? 'Ø£Ø¹Ù…Ø§Ù„' : 'Ù†Ø¸Ù…'} (Ø§Ù…ØªØ­Ø§Ù† ${examIndex + 1})</h3>`;
      html += `<p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${exam.questions.length}</p>`;
      exam.questions.forEach((q, i) => {
        html += `<div style="margin:15px 0;padding:10px;background:rgba(30,50,100,0.2);border-radius:8px;"><strong>Ø³Ø¤Ø§Ù„ ${i+1}:</strong> ${q.text}<br>`;
        if (q.type === 'mcq') {
          q.options.forEach((opt, j) => {
            html += `<div>${String.fromCharCode(65+j)}. ${opt} ${j === q.correct ? '(âœ“)' : ''}</div>`;
          });
        } else if (q.type === 'truefalse') {
          html += `<div>Ø§Ù„Ø®ÙŠØ§Ø± 1: ${q.options[0]} ${q.correct === 0 ? '(âœ“)' : ''} | Ø§Ù„Ø®ÙŠØ§Ø± 2: ${q.options[1]} ${q.correct === 1 ? '(âœ“)' : ''}</div>`;
        } else if (q.type === 'fill') {
          html += `<div>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${q.options[0]} ${q.correct === 0 ? '(âœ“)' : ''}</div>`;
        }
        html += `</div>`;
      });
      const examViewInline = document.getElementById('exam-view-inline');
      examViewInline.innerHTML = html;
      examViewInline.classList.remove('hidden');
    };

    window.deleteSpecificExam = function(branch, subject, examIndex) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù…ØªØ­Ø§Ù† "${subject}" (Ø±Ù‚Ù… ${examIndex + 1})ØŸ`)) return;
      const exams = SUBJECT_EXAMS[branch][subject].exams;
      exams.splice(examIndex, 1);
      if (exams.length === 0) {
        SUBJECT_EXAMS[branch][subject].enabled = false;
      }
      saveToStorage('subjectExams', SUBJECT_EXAMS);
      renderUploadedExams();
      updateDashboardStats();
      showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†');
    };

    function renderLogs() {
      const results = loadFromStorage('examResults') || {};
      const tbody = document.getElementById('logs-table-body');
      tbody.innerHTML = '';
      let hasData = false;
      Object.keys(results).forEach(username => {
        results[username].forEach(result => {
          hasData = true;
          const row = document.createElement('tr');
          const date = new Date(result.date).toLocaleDateString('ar-EG');
          row.innerHTML = `
            <td>${username}</td>
            <td>${result.subject} ${result.examIndex !== undefined ? `(Ø§Ù…ØªØ­Ø§Ù† ${result.examIndex + 1})` : ''}</td>
            <td>${date}</td>
            <td>${result.percentage}%</td>
            <td>${result.grade}</td>
            <td><button class="btn-delete-log" onclick="deleteLogEntry('${username}', '${result.subject}', '${result.date}')">Ø­Ø°Ù</button></td>
          `;
          tbody.appendChild(row);
        });
      });
      if (!hasData) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</td></tr>`;
      }
    }

    window.deleteLogEntry = function(username, subject, date) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù†ØªÙŠØ¬Ø© Ø§Ù…ØªØ­Ø§Ù† "${subject}" Ù„Ù€ "${username}"ØŸ`)) return;
      const results = loadFromStorage('examResults') || {};
      if (results[username]) {
        results[username] = results[username].filter(r => !(r.subject === subject && r.date === date));
        if (results[username].length === 0) {
          delete results[username];
        }
        saveToStorage('examResults', results);
        renderLogs();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©');
      }
    };

    function exportGrades() {
      const results = loadFromStorage('examResults') || {};
      let csvContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…,Ø§Ù„Ù…Ø§Ø¯Ø©,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø¯Ø±Ø¬Ø©,Ø§Ù„ØªÙ‚Ø¯ÙŠØ±\n";
      Object.keys(results).forEach(username => {
        results[username].forEach(result => {
          const row = [username, result.subject + (result.examIndex !== undefined ? ` (Ø§Ù…ØªØ­Ø§Ù† ${result.examIndex + 1})` : ''), result.date, result.percentage, result.grade].map(v => `"${v}"`).join(",");
          csvContent += row + "\n";
        });
      });
      const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "grades.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportPassed() {
      const results = loadFromStorage('examResults') || {};
      let csvContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…,Ø§Ù„Ù…Ø§Ø¯Ø©,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø¯Ø±Ø¬Ø©,Ø§Ù„ØªÙ‚Ø¯ÙŠØ±\n";
      Object.keys(results).forEach(username => {
        results[username].forEach(result => {
          if (result.percentage >= 60) {
            const row = [username, result.subject + (result.examIndex !== undefined ? ` (Ø§Ù…ØªØ­Ø§Ù† ${result.examIndex + 1})` : ''), result.date, result.percentage, result.grade].map(v => `"${v}"`).join(",");
            csvContent += row + "\n";
          }
        });
      });
      const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "passed_students.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportStats() {
      const results = loadFromStorage('examResults') || {};
      let totalExams = 0;
      let passedExams = 0;
      let failedExams = 0;
      let sumPercentages = 0;
      Object.keys(results).forEach(username => {
        results[username].forEach(result => {
          totalExams++;
          sumPercentages += result.percentage;
          if (result.percentage >= 60) {
            passedExams++;
          } else {
            failedExams++;
          }
        });
      });
      const avgPercentage = totalExams > 0 ? (sumPercentages / totalExams).toFixed(2) : 0;
      let csvContent = "Ø§Ù„Ù…Ù‚ÙŠØ§Ø³,Ø§Ù„Ù‚ÙŠÙ…Ø©\n";
      csvContent += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª,${totalExams}\n`;
      csvContent += `Ø§Ù„Ù†Ø§Ø¬Ø­ÙˆÙ†,${passedExams}\n`;
      csvContent += `Ø§Ù„Ø±Ø§Ø³Ø¨ÙˆÙ†,${failedExams}\n`;
      csvContent += `Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª,${avgPercentage}%\n`;
      const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "exam_statistics.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // === Event Listeners ===
    document.getElementById('btn-register').onclick = () => switchScreen('register-screen');
    document.getElementById('btn-login').onclick = () => switchScreen('login-screen');
    document.getElementById('btn-back-to-auth').onclick = () => switchScreen('auth-screen');
    document.getElementById('btn-back-to-auth2').onclick = () => switchScreen('auth-screen');
    document.getElementById('reg-branch').onchange = function() {};
    document.getElementById('btn-submit-register').onclick = function() {
      const username = document.getElementById('reg-username').value.trim();
      const branch = document.getElementById('reg-branch').value;
      const password = document.getElementById('reg-password').value;
      const confirm = document.getElementById('reg-confirm').value;
      const captchaInput = document.getElementById('register-captcha-input').value.trim();
      if (!username || !branch || !password || !confirm) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
        return;
      }
      if (password !== confirm) {
        alert('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
        return;
      }
      if (!isValidPassword(password)) {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØªØªØ¶Ù…Ù† Ø­Ø±ÙˆÙÙ‹Ø§ ÙˆØ£Ø±Ù‚Ø§Ù…Ù‹Ø§');
        return;
      }
      if (captchaInput !== registerCaptcha) {
        alert('Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
      }
      const users = loadFromStorage('users') || {};
      if (users[username]) {
        alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
      }
      const mockIP = generateMockIP();
      users[username] = {
        username,
        branch,
        password: simpleHash(password),
        plainPassword: password,
        registered: new Date().toISOString(),
        lastSeen: new Date().toISOString(),
        ip: mockIP,
        banned: false,
        ipBanned: false
      };
      saveToStorage('users', users);
      saveToStorage('auth', { username });
      currentUser = { username };
      document.getElementById('login-username').value = username;
      document.getElementById('login-password').value = password;
      switchScreen('login-screen');
    };

    document.getElementById('btn-submit-login').onclick = function() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return;
      }
      if (username === ADMEN_USERNAME && password === ADMEN_PASSWORD) {
        saveToStorage('auth', { username });
        currentUser = { username };
        switchScreen('admin-dashboard');
        return;
      }
      const users = loadFromStorage('users') || {};
      const user = users[username];
      if (!user || user.password !== simpleHash(password)) {
        alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        return;
      }
      if (user.banned) {
        alert('Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±');
        return;
      }
      saveToStorage('auth', { username });
      currentUser = { username };
      switchScreen('student-dashboard');
    };

    document.getElementById('btn-start-exam').onclick = () => {
      const userExams = completedExams[currentUser.username] || {};
      const { name, branch, examIndex } = currentExamSubject;
      const examKey = `${branch}-${name}-exam${examIndex}`;
      if (userExams[examKey] === 'completed') {
        alert('Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§Ù„ÙØ¹Ù„');
        switchScreen('student-dashboard');
        return;
      }
      startCountdown(beginExam);
    };

    document.getElementById('btn-back-from-exam').onclick = () => switchScreen('student-dashboard');
    document.getElementById('btn-submit-exam').onclick = submitExam;
    document.getElementById('btn-back-to-dashboard').onclick = () => switchScreen('student-dashboard');
    document.getElementById('save-notes').onclick = function() {
      const notes = loadFromStorage('userNotes') || {};
      notes[currentUser.username] = document.getElementById('user-notes').value;
      saveToStorage('userNotes', notes);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
    };
    document.getElementById('btn-logout').onclick = function() {
      localStorage.removeItem('auth');
      currentUser = null;
      switchScreen('auth-screen');
    };
    document.querySelectorAll('.nav-item').forEach(item => {
      item.onclick = function() {
        const target = this.getAttribute('data-screen');
        switchScreen(target);
      };
    });
    window.addEventListener('load', () => {
      const storedExams = loadFromStorage('subjectExams');
      if (storedExams) {
        Object.keys(storedExams).forEach(branch => {
          Object.keys(storedExams[branch]).forEach(subject => {
            const exam = storedExams[branch][subject];
            if (exam.questions && !exam.exams) {
              storedExams[branch][subject] = {
                enabled: exam.enabled,
                exams: exam.questions.length > 0 ? [{ questions: exam.questions }] : []
              };
            }
          });
        });
        Object.assign(SUBJECT_EXAMS, storedExams);
      }
      const storedCompleted = loadFromStorage('completedExams');
      if (storedCompleted) {
        Object.assign(completedExams, storedCompleted);
      }
      initApp();
    });
    window.addEventListener('beforeunload', updateLastSeen);
  </script>
</body>
</html>
